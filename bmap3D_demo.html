<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Blackwell Map (HTML)</title>
<link rel="stylesheet" type="text/css" href="bcss.css">
</head>
<body>
<div>
<div>
<canvas id="bmap" width="500" height = "500" style="border:1px solid #000000;float:left">Your browser insufficiently supports HTML5</canvas>
</div>
<div id="directoryPanel" style="border:1px solid #000000;float:left">
</div>
</div>
<div>
<canvas id="areaList" width="500" height = "300" style="border:1px solid #000000;"></canvas>
</div>

<div id="testDiv">
<p>
default
</p>
</div>
<div id="test2">
<button onclick="testFunction1()">1</button>
<button onclick="testFunction2()">2</button>
<button onclick="testFunction3()">3</button>
<button onclick="testFunction4()">4</button>

</div>
<script>
var c=document.getElementById("bmap");
var ctx=c.getContext("2d");

var c2 = document.getElementById("areaList");
var ctx2 = c2.getContext("2d");

//var grd = ctx.createLinearGradient(0,0,200,0);
var height = 500;
var width = 500;
var highestX = 0;
var lowestX = width*8;
var highestY = 0;

//initialise selectedFloor to the highest level present to show all elements at the beginning.

var selectedFloor = 2;
var selectedDept = null;

var mousePos;
var mdFlag = false;
var isoFlag = true;

var angleLat = 45;
var angleLon = 70;

var clickPoint;

var centreOffset = {x:0, y:0};
var isometry;
var selectionCoords;
var lowestY = height*8;
var verticalInterval = 450;
//raises the selected area by the given number of pixels
var selectionHeightAdd = 10;
//Coordinates layer
var cL = 0;

//Divides coordinate matrix by given value
var scale = 10;
var centre = [width*scale/2-1500, height*scale/2];
//var 2ndbuffer = [10,10]
var isoAreas;
var drawAreas;
var bspTree = new BSPTree();

c.addEventListener('mousemove', function(e)
{
        mousePos = getMousePos(c,e);
       
        if (mdFlag == true)
        {
                
				if (isoFlag == true)
                {
                        
						angleLat = startAngleLat - (mousePos.x - clickPoint.x);
                        angleLon = startAngleLon - ((mousePos.y - clickPoint.y));
						
                        if (angleLat >= 360)
                        {
                                
							angleLat = angleLat - 360;
								
                        }
       
                        if (angleLon > 90)
                        {
                            angleLon = 90;
                        }
                       
                        if (angleLon < -90)
                        {
                            angleLon = -90;
                        }
						
                }
				
                else
                {
                        centreOffset.x = (mousePos.x - clickPoint.x);
                        centreOffset.y = (mousePos.y - clickPoint.y);
                }
				
				//calcPerspectiveVect();
                
                //perspectiveVector = [Math.sin(angleLat/180*Math.PI)+Math.cos(angleLat/180*Math.PI),Math.cos(angleLat/180*Math.PI)+Math.sin(angleLat/180*Math.PI),Math.cos(angleLon/180*Math.PI)];
				//document.getElementById("testDiv").innerHTML="<p>" + perspectiveVector + "</p>" + "<p>Vertical angle:" + angleLon + "</p>" + "<p>Horizontal angle:" + angleLat + "</p>";
        }
        redraw(angleLat, angleLon, isoFlag);
        //document.getElementById("testDiv").innerHTML="<p>" + ((mousePos.y - clickPoint.y)/100) + "</p>";
        
}
, false
);

c.addEventListener('mousedown', function(e)
{
        mdFlag = true;
        mousePos = getMousePos(c, e);
        clickPoint = mousePos;
        var newSelection = checkClickAgainstAreas();
        //document.getElementById("testDiv").innerHTML="<p>" + newSelection + "</p>";
        startAngleLat = angleLat;
        startAngleLon = angleLon;
        redraw(angleLat, angleLon, isoFlag);
		//findPerspectiveLine(mousePos);
}
,false);

document.addEventListener('mouseup', function(e)
{
        mdFlag = false;
}
,false);

c2.addEventListener('mousedown', function(e)
{
        getSelectedArea(e);
       
       
}

,false);

var areaNames = [];

// ** Declares height values for coordinates. Determines the interval between level as mediated by isometery() ** //

var philSocH = -1.75;
var theoPsyhEdH = -1.5;
var bioSciH = -1.25;
var balconyH = -1;
var groundH = 0;
var langLitH = 1;
var histH = 2;

// ** Declares geometry in the format [floor[area[[coordinates]colour]]] ** //

/* WARNING: designed so that every element conforms to a single plane. While it will work with multiplanar elements, 
   it will give rise to kookiness in regards to the interpretation of position relative to other elements.*/

// ACTUAL AREAS   
   /*
var areas = [


//NORRINGTON_4 (Philosophy and Sociology)

        [
                //Philosophy
                                       
                [
                        [1992, 5088, philSocH],
                        [1992, 5008, philSocH],
                        [2024, 5008, philSocH],
                        [2024, 4944, philSocH],
                        [1912, 4944, philSocH],
                        [1912, 4376, philSocH],
                        [1984, 4376, philSocH],
                        [1984, 4416, philSocH],
                        [2048, 4416, philSocH],
                        [2048, 4304, philSocH],
                        [2496, 4304, philSocH],
                        [2496, 4376, philSocH],
                        [2456, 4376, philSocH],
                        [2456, 4440, philSocH],
                        [2368, 4440, philSocH],
                        [2368, 5088, philSocH]
                ]
                ,-1.75
                ,"#CCDDDD"
                ,"Philosophy"
        ],     
               
                //Sociology
        [      
                [
                        [2368, 4440, philSocH],
                        [2368, 4976, philSocH],
                        [2504, 4976, philSocH],
                        [2504, 5000, philSocH],
                        [2576, 5000, philSocH],
                        [2576, 4440, philSocH]
                ]
                ,-1.75
                ,"#CCDDDD"
                , "Sociology"
        ],
       

//NORRINGTON_3 (Theology, Psychology, Education_lower)

       
                //Theology
        [
                [
                       
                        [1704, 4080, theoPsyhEdH],
                        [1704, 4384, theoPsyhEdH],
                        [1896, 4384, theoPsyhEdH],
                        [1896, 4264, theoPsyhEdH],
                        [1984, 4264, theoPsyhEdH],
                        [1984, 4240, theoPsyhEdH],
                        [2496, 4240, theoPsyhEdH],
                        [2496, 4288, theoPsyhEdH],
                        [2608, 4288, theoPsyhEdH],
                        [2608, 4376, theoPsyhEdH],
                        [2640, 4376, theoPsyhEdH],
                        [2640, 5000, theoPsyhEdH],
                        [2584, 5000, theoPsyhEdH],
                        [2584, 5328, theoPsyhEdH],
                        [2904, 5328, theoPsyhEdH],
                        [2904, 4080, theoPsyhEdH]
                ]
                ,-1.5
                ,"#889999"
                , "Theology"
        ],
                //Psychology
        [      
                [
                        [2584, 5112, theoPsyhEdH],
                        [2496, 5112, theoPsyhEdH],
                        [2496, 5136, theoPsyhEdH],
                        [1992, 5136, theoPsyhEdH],
                        [1992, 5088, theoPsyhEdH],
                        [1784, 5088, theoPsyhEdH],
                        [1784, 5320, theoPsyhEdH],
                        [2584, 5320, theoPsyhEdH]
                ]
                ,-1.5
                ,"#889999"
                ,"Psychology"
        ],
               
                //Lower Education
        [
                [
                        [1784, 5088, theoPsyhEdH],
                        [1784, 5328, theoPsyhEdH],
                        [1440, 5328, theoPsyhEdH],
                        [1440, 5224, theoPsyhEdH],
                        [1408, 5224, theoPsyhEdH],
                        [1408, 4880, theoPsyhEdH],
                        [1480, 4880, theoPsyhEdH],
                        [1480, 5080, theoPsyhEdH],
                        [1480, 5088, theoPsyhEdH]
                ]
                ,-1.5
                ,"#889999"
                ,"Education"
        ],
                //N3_int
        [
                [
                        [1880, 5088, theoPsyhEdH],
                        [1880, 5008, theoPsyhEdH],
                        [1848, 5008, theoPsyhEdH],
                        [1848, 4384, theoPsyhEdH],
                        [1704, 4384, theoPsyhEdH],
                        [1704, 4168, theoPsyhEdH],
                        [1592, 4168, theoPsyhEdH],
                        [1592, 4560, theoPsyhEdH],
                        [1696, 4560, theoPsyhEdH],
                        [1696, 5088, theoPsyhEdH]
                ]
                ,-1.5
                ,"#889999"
                ,null
        ],
       


//NORRINGTON_2 

        [
                //Biology
                [
                        [1960, 2208, bioSciH],
                        [1496, 2208, bioSciH],
                        [1496, 2904, bioSciH],
                        [1632, 3040, bioSciH],
                        [1960, 3040, bioSciH]
                ]
                ,-1.25
                ,"#99AAAA"
                ,"Medicine and biology"
        ],
                //Science
        [
                [
                        [1960, 2320, bioSciH],
                        [2120, 2320, bioSciH],
                        [2120, 2392, bioSciH],
                        [2520, 2392, bioSciH],
                        [2520, 3608, bioSciH],
                        [2120, 3608, bioSciH],
                        [1960, 3448, bioSciH]
                ]
                ,-1.25
                ,"#99AAAA"
                ,"Science"
        ],
                //Customer services
        [
                [
                        [2584, 3888, bioSciH],
                        [2584, 4016, bioSciH],
                        [1712, 4016, bioSciH],
                        [1712, 3888, bioSciH]
                ]
                ,-1.25
                ,"#99AAAA"
                ,"Customer services"
        ],
                //N2_int
        [
                [
                        [2120, 3608, bioSciH],
                        [2584, 3608, bioSciH],
                        [2584, 3720, bioSciH],
                        [2680, 3720, bioSciH],
                        [2680, 3888, bioSciH],
                        [1712, 3888, bioSciH],
                        [1712, 4016, bioSciH],
                        [1704, 4016, bioSciH],
                        [1704, 4064, bioSciH],
                        [1592, 4064, bioSciH],
                        [1592, 4024, bioSciH],
                        [1480, 4024, bioSciH],
                        [1480, 3936, bioSciH],
                        [1592, 3936, bioSciH],
                        [1592, 3600, bioSciH],
                        [1632, 3600, bioSciH],
                        [1632, 3432, bioSciH],
                        [1576, 3432, bioSciH],
                        [1576, 3208, bioSciH],
                        [1632, 3208, bioSciH],
                        [1632, 3040, bioSciH],
                        [1960, 3040, bioSciH],
                        [1960, 3448, bioSciH]
                ]
                ,-1.25
                ,"#99AAAA"
                ,null
        ],
       
        //EdSlope
        [
                [      
                        [1480, 3936, bioSciH],
                        [1592, 3936, bioSciH],
                        [1592, 4880, theoPsyhEdH],
                        [1480, 4880, theoPsyhEdH],
                       
                ]
                ,-1.5
                ,"#99AAAA"
                ,"Education2"
        ],
        //edStairs
        [
                [
                        
                        [1704, 4168, theoPsyhEdH],
                        [1592, 4168, theoPsyhEdH],                      
                        [1592, 4064, bioSciH],
                        [1704, 4064, bioSciH]
                ]
                , -1.5
                , "#99AAAA"
                , "Education3"
        ],
       

//
//NORRINGTON_1

       
                //Botany,etc
        [
                [
                        [1040, 3608, balconyH],
                        [792, 3608, balconyH],
                        [752, 3568, balconyH],
                        [752, 3088, balconyH],
                        [840, 3000, balconyH],
                        [1096, 3000, balconyH],
                        [1096, 3040, balconyH],
                        [1128, 3040, balconyH],
                        [1464, 3432, balconyH],
                        [1464, 3480, balconyH],
                        [1040, 3480, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Botany etc"
        ],
                //N1_i
        [
                [
                        [1128, 3040, balconyH],
                        [1128, 2904, balconyH],
                        [1264, 2904, balconyH],
                        [1264, 3032, balconyH],
                        [1280, 3032, balconyH],
                        [1280, 2648, balconyH],
                        [1432, 2648, balconyH],
                        [1432, 2920, balconyH],
                        [1568, 3064, balconyH],
                        [1568, 3184, balconyH],
                        [1456, 3184, balconyH],
                        [1464, 3432, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,null
        ],
               
                //Politics
        [
                [
                        [1432, 2648, balconyH],
                        [1272, 2648, balconyH],
                        [1272, 2424, balconyH],
                        [1160, 2424, balconyH],
                        [1184, 2160, balconyH],
                        [1200, 2160, balconyH],
                        [1200, 1632, balconyH],
                        [1944, 1632, balconyH],
                        [1944, 2144, balconyH],
                        [1432, 2144, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Politics"
        ],
               
                //Travel
        [
                [
                        [1968, 2200, balconyH],
                        [1968, 2144, balconyH],
                        [1944, 2144, balconyH],
                        [1944, 1544, balconyH],
                        [2328, 1544, balconyH],
                        [2328, 2144, balconyH],
                        [2584, 2144, balconyH],
                        [2584, 2328, balconyH],
                        [2136, 2328, balconyH],
                        [2136, 2200, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Travel"
        ],
                //Music(lower)
        [
                [
                        [2144, 1544, balconyH],
                        [2144, 1432, balconyH],
                        [2128, 1432, balconyH],
                        [2128, 1528, balconyH],
                        [1920, 1528, balconyH],
                        [1920, 1160, balconyH],
                        [1952, 1160, balconyH],
                        [1952, 488, balconyH],
                        [1800, 488, balconyH],
                        [1800, 192, balconyH],
                        [2080, 192, balconyH],
                        [2080, 1032, balconyH],
                        [2104, 1032, balconyH],
                        [2104, 1024, balconyH],
                        [2344, 1024, balconyH],
                        [2344, 1128, balconyH],
                        [2320, 1128, balconyH],
                        [2320, 1432, balconyH],
                        [2328, 1544, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Music"
        ],
                //Law
        [
                [
                        [2816, 3880, balconyH],
                        [2816, 3864, balconyH],
                        [2688, 3864, balconyH],
                        [2688, 5080, balconyH],
                        [1408, 5080, balconyH],
                        [1408, 5224, balconyH],
                        [1440, 5224, balconyH],
                        [1440, 5320, balconyH],
                        [2904, 5320, balconyH],
                        [2904, 3880, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Law"
        ],
                //Maps
        [
                [
                        [2584, 3304, balconyH],
                        [2584, 3600, balconyH],
                        [2688, 3600, balconyH],
                        [2688, 3864, balconyH],
                        [2816, 3864, balconyH],
                        [2816, 3848, balconyH],
                        [2992, 3848, balconyH],
                        [2992, 3304, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Maps"
        ],
                //Business
        [
                [
                        [2584, 2144, balconyH],
                        [2584, 3304, balconyH],
                        [3008, 3304, balconyH],
                        [3008, 2144, balconyH]
                ]
                ,-1
                ,"#CCDDDD"
                ,"Business"
        ],


//GROUND FLOOR

       
        [
                //Music(upper)
                [
                        [2224, 528, groundH],
                        [2328, 528, groundH],
                        [2328, 160, groundH],
                        [2360, 160, groundH],
                        [2360, 96, groundH],
                        [2304, 96, groundH],
                        [2304, 112, groundH],
                        [2296, 112, groundH],
                        [2296, 96, groundH],
                        [2216, 96, groundH],
                        [2216, 112, groundH],
                        [2208, 112, groundH],
                        [2208, 32, groundH],
                        [1840, 32, groundH],
                        [1840, 48, groundH],
                        [1856, 48, groundH],
                        [1856, 88, groundH],
                        [1832, 88, groundH],
                        [1832, 536, groundH],
                        [1968, 536, groundH],
                        [1968, 744, groundH],
                        [1824, 744, groundH],
                        [1808, 984, groundH],
                        [1904, 984, groundH],
                        [1904, 976, groundH],
                        [1928, 976, groundH],
                        [1928, 984, groundH],
                        [2224, 984, groundH]
                ]
               
                ,0
                ,"#889999"
                ,"Music2"
        ],
                //General
        [
                [
                        [40, 152, groundH],
                        [536, 120, groundH],
                        [536, 328, groundH],
                        [576, 328, groundH],
                        [576, 168, groundH],
                        [664, 168, groundH],
                        [656, 72, groundH],
                        [1104, 40, groundH],
                        [1104, 728, groundH],
                        [1072, 728, groundH],
                        [1072, 880, groundH],
                        [1008, 880, groundH],
                        [952, 824, groundH],
                        [848, 928, groundH],
                        [896, 976, groundH],
                        [896, 1112, groundH],
                        [880, 1112, groundH],
                        [880, 1144, groundH],
                        [896, 1144, groundH],
                        [896, 1232, groundH],
                        [864, 1232, groundH],
                        [864, 1320, groundH],
                        [848, 1320, groundH],
                        [848, 1352, groundH],
                        [856, 1352, groundH],
                        [856, 2104, groundH],
                        [600, 2104, groundH],
                        [600, 2712, groundH],
                        [320, 2712, groundH],
                        [320, 1560, groundH],
                        [416, 1560, groundH],
                        [416, 1328, groundH],
                        [384, 1328, groundH],
                        [384, 1344, groundH],
                        [112, 1344, groundH]
                ]                      
                ,0
                ,"#889999"
                ,"General fiction"
        ],
                //DVD

        [
                [
                        [872, 1352, groundH],
                        [872, 1560, groundH],
                        [856, 1560, groundH],
                        [856, 2088, groundH],
                        [1080, 2088, groundH],
                        [1080, 2024, groundH],
                        [1088, 2024, groundH],
                        [1088, 1840, groundH],
                        [1080, 1840, groundH],
                        [1080, 1808, groundH],
                        [1088, 1808, groundH],
                        [1088, 1608, groundH],
                        [1080, 1608, groundH],
                        [1080, 1576, groundH],
                        [1088, 1576, groundH],
                        [1088, 1344, groundH]
                ]                      
                ,0
                ,"#889999"
                ,"DVD"
        ],     
                //Childrens
        [
                [
                        [856, 2088, groundH],
                        [1120, 2088, groundH],
                        [1120, 2016, groundH],
                        [1240, 2016, groundH],
                        [1248, 2120, groundH],
                        [1208, 2120, groundH],
                        [1208, 2232, groundH],
                        [1120, 2232, groundH],
                        [1120, 2192, groundH],
                        [1080, 2192, groundH],
                        [1080, 2680, groundH],
                        [1040, 2680, groundH],
                        [1040, 2712, groundH],
                        [1088, 2712, groundH],
                        [1088, 2736, groundH],
                        [1120, 2736, groundH],
                        [1120, 2720, groundH],
                        [1272, 2712, groundH],
                        [1272, 3296, groundH],
                        [1264, 3296, groundH],
                        [1264, 3392, groundH],
                        [1192, 3392, groundH],
                        [1192, 3464, groundH],
                        [1104, 3464, groundH],
                        [1104, 3424, groundH],
                        [1064, 3424, groundH],
                        [1008, 3360, groundH],
                        [896, 3464, groundH],
                        [744, 3464, groundH],
                        [640, 3360, groundH],
                        [640, 3056, groundH],
                        [728, 2992, groundH],
                        [728, 2736, groundH],
                        [744, 2736, groundH],
                        [744, 2696, groundH],
                        [696, 2696, groundH],
                        [696, 2680, groundH],
                        [624, 2680, groundH],
                        [624, 2664, groundH],
                        [600, 2664, groundH],
                        [600, 2104, groundH],
                        [856, 2104, groundH]
                ]
                ,0
                ,"#889999"
                ,"Childrens"
        ],
       

//FIRST FLOOR



       
                //poetry
        [
                [
                        [848, 720, langLitH],
                        [848, 704, langLitH],
                        [840, 704, langLitH],
                        [840, 536, langLitH],
                        [928, 448, langLitH],
                        [1136, 448, langLitH],
                        [1136, 696, langLitH],
                        [1048, 696, langLitH],
                        [1048, 704, langLitH],
                        [1024, 704, langLitH],
                        [1024, 720, langLitH]
                ]
                ,1
                ,
                "#CCDDDD"
                ,"Poetry"
        ],
               
                //First floor landing
        [
                [
                       
                        [808, 720, langLitH],
                        [1048, 720, langLitH],
                        [1048, 992, langLitH],
                        [848, 992, langLitH],
                        [848, 1072, langLitH],
                        [840, 1072, langLitH],
                        [840, 1256, langLitH],
                        [824, 1256, langLitH],
                        [824, 1288, langLitH],
                        [640, 1288, langLitH],
                        [640, 888, langLitH]
                ]
                ,1
                ,
                "#CCDDDD"
                ,null
        ],
                //cafe
        [
                [
                        [808, 720, langLitH],
                        [808, 704, langLitH],
                        [816, 704, langLitH],
                        [816, 536, langLitH],
                        [728, 448, langLitH],
                        [496, 448, langLitH],
                        [496, 288, langLitH],
                        [528, 288, langLitH],
                        [528, 320, langLitH],
                        [752, 320, langLitH],
                        [824, 248, langLitH],
                        [824, 56, langLitH],
                        [528, 56, langLitH],
                        [528, 184, langLitH],
                        [496, 184, langLitH],
                        [496, 120, langLitH],
                        [40, 152, langLitH],
                        [64, 464, langLitH],
                        [232, 448, langLitH],
                        [248, 712, langLitH],
                        [72, 720, langLitH],
                        [112, 1280, langLitH],
                        [640, 1256, langLitH],
                        [640, 888, langLitH]
                ]
                ,1
                ,
                "#CCDDDD"
                ,"Cafe"
        ],
               
                //Literature
        [
                [
                        [640, 1288, langLitH],
                        [872, 1288, langLitH],
                        [872, 1360, langLitH],
                        [1048, 1360, langLitH],
                        [1048, 2608, langLitH],
                        [720, 2608, langLitH],
                        [608, 2496, langLitH],
                        [608, 2368, langLitH],
                        [312, 2368, langLitH],
                        [312, 1496, langLitH],
                        [608, 1496, langLitH],
                        [608, 1288, langLitH]
                ]
                ,1
                ,
                "#CCDDDD"
                ,"Literature"
        ],
                //Languages
        [
                [              
                        [1048, 2232, langLitH],
                        [1072, 2232, langLitH],
                        [1072, 2208, langLitH],
                        [1208, 2216, langLitH],
                        [1224, 2568, langLitH],
                        [1224, 3296, langLitH],
                        [1072, 3296, langLitH],
                        [1072, 3224, langLitH],
                        [1048, 3224, langLitH],
                        [1048, 3296, langLitH],
                        [608, 3296, langLitH],
                        [536, 3216, langLitH],
                        [536, 3104, langLitH],
                        [440, 3104, langLitH],
                        [440, 2856, langLitH],
                        [648, 2856, langLitH],
                        [648, 2864, langLitH],
                        [768, 2864, langLitH],
                        [768, 2608, langLitH],
                        [1048, 2608, langLitH]
                ]
                ,1
                ,
                "#CCDDDD"
                ,"Modern Languages"
        ],
       
//SECOND FLOOR

                //classics
        [
                [      
                        [496, 112, histH],
                        [32, 152,histH],
                        [104, 1184,histH],
                        [368, 1184,histH],
                        [368, 1064,histH],
                        [496, 1064,histH]
                ]
                ,
                2
                ,
                "#AABBBB"
                ,"Classics"
        ],

                        //2ndFloorLanding
        [
                [      
                        [496, 1064, histH],
                        [496, 752, histH],
                        [648, 752, histH],
                        [648, 800, histH],
                        [664, 800, histH],
                        [664, 736, histH],
                        [1048, 712, histH],
                        [1048, 1072, histH],
                        [976, 1072, histH],
                        [976, 1008, histH],
                        [864, 1008, histH],
                        [864, 1064, histH],
                        [840, 1064, histH],
                        [840, 1128, histH],
                        [776, 1128, histH],
                        [776, 1064, histH],
                        [768, 1064, histH],
                        [768, 1272, histH],
                        [744, 1272, histH],
                        [744, 1296, histH],
                        [528, 1296, histH],
                        [528, 1064, histH]

                       
                ]
                ,
                2
                ,
                "#AABBBB"
                ,null
        ],
                        //history
        [
                [
                        [608, 2584, histH],
                        [608, 1472, histH],
                        [528, 1392, histH],
                        [528, 1296, histH],
                        [1048, 1296, histH],
                        [1048, 2600, histH],
                        [1000, 2600, histH],
                        [1000, 2616, histH],
                        [672, 2616, histH],
                        [672, 2584, histH]
                ]
                ,
                2
                ,
                "#AABBBB"
                ,"History"
        ],     
                        //rarebooks
        [
                [
                        [760, 2616, histH],
                        [760, 3344, histH],
                        [1168, 3344, histH],
                        [1168, 3288, histH],
                        [1240, 3288, histH],
                        [1240, 2672, histH],
                        [1048, 2672, histH],
                        [1048, 2632, histH],
                        [1000, 2632, histH],
                        [1000, 2616, histH]
                ]
                ,
                2
                ,
                "#AABBBB"
                ,"Rare books"
               
        ],             
        //secondhand books

        [
                [
                       
					[528, 1392, histH],
					[456, 1464, histH],
					[312, 1464, histH],
					[312, 2432, histH],
					[552, 2432, histH],
					[552, 2384, histH],
					[608, 2384, histH],
					[608, 1472, histH]
                       
                ]
                ,
                2
                ,
                "#AABBBB"
                ,"Secondhand books"
        ],
		
		//TEST SECTION
		[
			[
				[2400, 2400, 0],
				[2500, 2400, 0],
				[2500, 2500, 0],
				[2400, 2500, 0]
			]
			,3
			,"#BADA55"
			,"Test Section 2"
		],
		[
			[
				[2400, 2400, 2],
				[2500, 2400, 2],
				[2500, 2500, 2],
				[2400, 2500, 2]
			]
			,3
			,"#BADA55"
			,"Test Section 2"
		]
		
]
*/


var areas =        

[
    [                               
        [
            [2000, 2500, -1],
			[3000, 2500, -1],
			[3000, 2500, 1],
			[2000, 2500, 1]
		]
		,[]
		,"#BADA55"
		,"Test 1"
	],
	
	[                               
        [
            [2000, 2000, 0],
			[3000, 2000, 0],
			[3000, 3000, 0],
			[2000, 3000, 0]
		]
		,[]
		,"#123456"
		,"Test 2"
	],
	
	[                               
        [
            [2500, 2000, -1],
			[2500, 3000, -1],
			
			
			[2500, 3000, 1],
			[2500, 2000, 1]
		]
		,[]
		,"#654321"
		,"Test 3"
	]

	
]

 var isoAreas;

 function getMousePos(c, e)
 {
        var rect = c.getBoundingClientRect();
               
       

        return {
                x: e.clientX - rect.left,
               
                y: e.clientY - rect.top
               
        };
}
/*
function getSelectedArea(e)
{
        var rect = c2.getBoundingClientRect();
        document.getElementById("testDiv").innerHTML="<p>" + (e.clientY-rect.top) +"</p>";
        if ((e.clientY - rect.top) < 33)
        {
                //selection = [2, 2];
        }
        else if ((e.clientY - rect.top) > 33 && (e.clientY - rect.top) < 66)
        {
                //selection = [3, 3];

        }
        else if ((e.clientY - rect.top) > 66)
        {
                //selection = [6, 3];
        }
        redraw(mousePos.x, 3, isoFlag);
       
}
*/
/*
function centreGeometry()
{
        
		var centre = [width*scale/2, height*scale/2];
        xTrans = (centre[0]-((highestX+lowestX)/2));
        yTrans = (centre[1]-((highestY + lowestY)/2));
       
       
        for(var p = 0; p < isoAreas.length; p++)
        {              

                for (var i = 0; i < isoAreas[p][cL].length; i++)
                {
                       
                        isoAreas[p][cL][i][0] = isoAreas[p][cL][i][0]+xTrans;
                        isoAreas[p][cL][i][1] = isoAreas[p][cL][i][1]+yTrans;
                       
                       
                }
               
        }
        
}


function highestLowest()
{
		
	for(var p = 0; p < isoAreas.length; p++)
	{
		var cAreaCoords = isoAreas[p][cL];
	   
		for (var i = 0; i < cAreaCoords.length; i++)
		{
			   
			//X
		   
			if (cAreaCoords[i][0] > highestX)
			{
					highestX = cAreaCoords[i][0];

			}
			else if (cAreaCoords[i][0] < lowestX)
			{
					lowestX = cAreaCoords[i][0];
			}
		   
			//Y
		   
			if (cAreaCoords[i][1] > highestY)
			{
					highestY = cAreaCoords[i][1];

			}
			else if (cAreaCoords[i][1] < lowestY)
			{
					lowestY = cAreaCoords[i][1];
			}                              
		}
		   
	}
		
}
*/
       
function isometry(angleD, vert)
{
        
		//highestLowest()
        //var centre = [width*scale/2, height*scale/2];
        //X/Y rotation
        
        for(var p = 0; p < isoAreas.length; p++)
        {      
                for (var i = 0; i < isoAreas[p][cL].length; i++)
                {                                                      
                        var cCoords = isoAreas[p][cL][i];
                       
                        var x = cCoords[0] - centre[0];
                        var y = cCoords[1] - centre[1];

                        var angle = (angleD/180)*Math.PI;
                       
                        cCoords[0] = ((x*(Math.cos(angle)))-(y*(Math.sin(angle))))+centre[0];
                        cCoords[1] = ((x*(Math.sin(angle)))+(y*(Math.cos(angle))))+centre[1];
                                      
                        // This if/else block adds extra height to selected areas as defined by the global variable selectionHeightAdd //

                       
						
                        //if (selectedDept == p)
                        //{
                        cCoords[1] = (cCoords[1]-(cCoords[1] - centre[1])*Math.cos(vert/180*Math.PI))-((areas[p][cL][i][2]*verticalInterval)*Math.cos(vert/180*Math.PI));                              
                        //}
                               
                        //else
                        //{
                                //cCoords[1] = (cCoords[1]-(cCoords[1] - centre[1])*Math.cos(vert/180*Math.PI))-((areas[p][cL][i][2]*verticalInterval)*Math.cos(vert/180*Math.PI))+selectionHeightAdd*Math.cos(vert/180*Math.PI);

                        //}
						
                         //document.getElementById("testDiv").innerHTML="<p>" + Math.cos(vert/180*Math.PI) + ", " + vert +"</p>";                                              
                }                              
        }
		
}

function resetAreas()
{
        var newList = traverseBSPTree(bspTree); 
		areas = [];
		for (var i = 0; i < newList.length; i++)
		{
			areas.push(newList[i]);
		}
		isoAreas = [];
        for(var p = 0; p < areas.length; p++)
        {      
               
                isoAreas[p] = [];
                isoAreas[p][0] = [];
               
                for (var i = 0; i < areas[p][cL].length; i++)
                {                              
                        isoAreas[p][0][i]=[];
                       
                        isoAreas[p][0][i].push(areas[p][0][i][0]);
                        isoAreas[p][0][i].push(areas[p][0][i][1]);
                               
                       
                       
                }
               
                isoAreas[p].push(areas[p][1]);
                isoAreas[p].push(areas[p][2]);
				isoAreas[p].push(areas[p][3]);
               
        }
}

function redraw(angleLat, angleLong, i)
{
        ctx.clearRect(0, 0, width, height);
        resetAreas();
        //highestLowest();
        //centreGeometry();
        if (i == true)
        {
                isometry(angleLat, angleLong);
        }
        ctx.fillStyle="#002147";
        ctx.fillRect(0,0,width,height);
       
        ctx.lineWidth = 1;
        for(var p = 0; p < isoAreas.length; p++)
        {
               
                //if (isoAreas[p][1][3] <= selectedFloor)
                {      
                        if (selectedDept == p)
                        {
                                ctx.fillStyle="#FF6600";
                        }
                        else
                        {
                                ctx.fillStyle=isoAreas[p][2];
                        }
               
                        ctx.beginPath();
                        var cC = isoAreas[p][cL];
                        ctx.moveTo(cC[0][0]/scale + centreOffset.x, cC[0][1]/scale + centreOffset.y);
               
                        for (var i = 1; i < cC.length; i++)
                        {
                                ctx.lineTo(cC[i][0]/scale + centreOffset.x, cC[i][1]/scale + centreOffset.y);
                        }
                        ctx.lineTo(cC[0][0]/scale + centreOffset.x, cC[0][1]/scale + centreOffset.y);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                }
        }
}

function drawSelectionOptions()
{

        var column = 10;
        var row = 10;

        var vertInt = 15;
        var horInt = 5;

        var rowWidth = 0 ;

        ctx2.fillStyle= "#002147";
        ctx2.fillRect(0,0,c2.width, c2.height);
        ctx2.font="12px blackwell_s";
        ctx2.textBaseline = "top";
        ctx2.fillStyle="#FFFFFF";
        ctx2.linewidth = 1;
        ctx2.strokeStyle = "#FFFFFF";
        /*

        //Old fixed list mode

        for (var i = 0; i < areaNames.length; i++)
        {
                rowWidth = areaNames[i][0]
                for (var o = 0; o < areaNames[i][1].length; o++)
                {
                       
                        ctx2.fillText(areaNames[i][1][o][0], row, column)
                       
                        column = column + vertInt;
                       
                }
               
                ctx2.strokeRect(row-5, 5, rowWidth, column);
               
               
                row = row + rowWidth+horInt;
                column = 10;           
       
        }
        */
}

function checkLineIntercept(a,b)
{
       
        clickX = (clickPoint.x - centreOffset.x) * scale;
        clickY = (clickPoint.y - centreOffset.y) * scale;
       
        var iShallReturn = false;
        if ((clickX < a[0] && clickX > b[0])||(clickX > a[0] && clickX < b[0]))
        {
               
                var xDiff = b[0] - a[0];
                var yDiff = b[1] - a[1];
               
                pxDiff = clickX - a[0];
               
               
                //being the y value at which the line intersects a verticle line from the point
                pyIntercept = ((pxDiff/xDiff)*yDiff)+ a[1];
               
                if(clickY > pyIntercept)
                {
                        iShallReturn = true;
                }
 
               
               
        }
		
       
        //document.getElementById("testDiv").innerHTML="<p>" + iShallReturn + ", A: " + a + ", B:" + b  + ", P: " + clickX + ", " + clickY +"</p>";

        return iShallReturn;
}

function checkAreaClicked(c)
{
        var internal = false;
        var interceptions = 0;
       
        for (var i = 0; i < c.length-1; i++)
        {
               
                if (checkLineIntercept(c[i], c[i+1]))
                {
                        interceptions++;
                }
               
               
               
        }

        if (checkLineIntercept(c[c.length-1], c[0]))
        {
                interceptions++;
        }
       
        if (interceptions % 2 == 1)
        {
                internal = true;
        }
       
        return internal
}

function checkClickAgainstAreas()
{      
        var topSelection = "null";
        for (var i = 0; i < isoAreas.length; i++)
        {
                if (isoAreas[i][1] <= selectedFloor)
                {
                        var coords = isoAreas[i][0];
               
                        if (checkAreaClicked(coords))
                        {
                                topSelection = [i];
                        }
                }
               
        }
        selectedDept = topSelection;

        return topSelection;
}

/*
function assignHeight()
{
       
        for (var i = 0; i < areas.length; i++)
        {
                var cHighMax;
                var cLowMax;
				
				cHighMax = areas[i][0][0][2];
                cLowMax = areas[i][0][0][2];
				
                for (var o = 0; o < areas[i][0].length; o++)
                {
                        if (areas[i][0][o][2] > cHighMax)
                        {
                                cHighMax = areas[i][0][o][2]
                        }
                        else if (areas[i][0][o][2] < cLowMax)
                        {
                                cLowMax = areas[i][0][o][2]
                        }
                       
                        areas[i][1] = (cLowMax + cHighMax)/2;
                       
                }
        }
       
}
*/
/*
function calibrateAbsGeo()
{
        assignHeight();
        areas.sort(function(a, b){return a[1]-b[1]});
       
}
*/



function findPerspectiveLine()
{
	/*
	cCoords[0] = ((x*(Math.cos(angle)))-(y*(Math.sin(angle))))+centre[0];
    cCoords[1] = ((x*(Math.sin(angle)))+(y*(Math.cos(angle))))+centre[1];
	*/
	
	/*
	if (selectedDept == p)
	{
			cCoords[1] = (cCoords[1]-(cCoords[1] - centre[1])*Math.cos(vert/180*Math.PI))
			
			
			-((areas[p][cL][i][2]*verticalInterval)*Math.cos(vert/180*Math.PI));
		   
	}
		   
	else
	{
			cCoords[1] = (cCoords[1]-(cCoords[1] - centre[1])*Math.cos(vert/180*Math.PI))-((areas[p][cL][i][2]*verticalInterval)*Math.cos(vert/180*Math.PI))+selectionHeightAdd*Math.cos(vert/180*Math.PI);

	}
	*/
	
	//This section finds the point in the z=0 plane:
	
	var angleH = -(angleLat/180)*Math.PI;
	var angleV = (angleLon/180)*Math.PI;
	
	/*
	var xCoord = isoAreas[0][0][0][0];
	var yCoord = isoAreas[0][0][0][1];
	
	var yCoord = (isoAreas[0][0][0][1]-centre[0]*Math.cos(angleV))/(1-Math.cos(angleV));
	
	var xCoord2 = xCoord - centre[0];
	var yCoord2 = yCoord - centre[1];	
	
	xCoord = xCoord2*(Math.cos(angleH))-yCoord2*(Math.sin(angleH))+centre[0];
	yCoord = xCoord2*(Math.sin(angleH))+yCoord2*(Math.cos(angleH))+centre[1];
	*/
	//From that point a line
	
	//var perspectiveVector = [verticalInterval*Math.cos(angleV)*Math.sin(-angleH),verticalInterval*Math.cos(angleV)*Math.cos(-angleH),1];
	var perspectiveVector = [Math.cos(angleV)*Math.sin(-angleH),Math.cos(angleV)*Math.cos(-angleH),Math.sin(-angleV)];

	//Line = [xCoord + perspectiveVector[0]*t, yCoord + perspectiveVector[1]*t, t]
	
	//return [xCoord, yCoord, perspectiveVector];
	return perspectiveVector;
	
	document.getElementById("testDiv").innerHTML="<p>"+perspectiveVector+"</p>";
	//document.getElementById("testDiv").innerHTML="<p>" + angleV/Math.PI*180 + ", " + Math.sin(angleV) + ", " + yCoord + "</p><p>isoArea[x]: " + isoAreas[0][0][0][0] + ", isoArea[y]: " + isoAreas[0][0][0][1] +"</p><p> + Cos(-angleH) * yCoord:  " + Math.cos(angleH)*yCoord + ", Sin(-angleH) * xCoord: " + Math.sin(angleH)*xCoord + "</p><p>[x,y]: " + [xCoord, yCoord] + "</p>";
}


function findPlane(a)
{
	var planeVectors = assemblePlaneVectors(a);
	var ortho = crossProduct3x2(planeVectors[0], planeVectors[1]);
	var scalarProduct = a[0][0]*ortho[0] + a[0][1]*ortho[1] + a[0][2]*ortho[2];
	return [[a[0][0], a[0][1], a[0][2]], ortho];
	//
}

function assemblePlaneVectors(a)
{
	var colinear = true;
	var notAPlane = true;
	var i = 0;
	var rv1 = [a[i+1][0]-a[i+0][0], a[i+1][1]-a[i+0][1], a[i+1][2]-a[i+0][2]];
	var rv2 = [a[i+2][0]-a[i+0][0], a[i+2][1]-a[i+0][1], a[i+2][2]-a[i+0][2]];
	
	while (testColinearity(rv1, rv2) == true && i <= a.length)
	{
		
		if (i+2 <= a.length)
		{
			var rv1 = [a[i+1][0]-a[i+0][0], a[i+1][1]-a[i+0][1], a[i+1][2]-a[i+0][2]];
			var rv2 = [a[i+2][0]-a[i+0][0], a[i+2][1]-a[i+0][1], a[i+2][2]-a[i+0][2]];
		}
		if (i+1 == a.length)
		{
			var rv1 = [a[i+1][0]-a[i+0][0], a[i+1][1]-a[i+0][1], a[i+1][2]-a[i+0][2]];
			var rv2 = [a[0][0]-a[i+0][0], a[0][1]-a[i+0][1], a[0][2]-a[i+0][2]];
		}
		if (i == a.length)
		{
			var rv1 = [a[0][0]-a[i+0][0], a[0][1]-a[i+0][1], a[0][2]-a[i+0][2]];
			var rv2 = [a[1][0]-a[i+0][0], a[1][1]-a[i+0][1], a[1][2]-a[i+0][2]];
		}
		i++;
	}
	
	if (testColinearity(rv1, rv2) == false)
	{
		notAPlane = false;
	}
	
	if (notAPlane == false)
	{
		return [rv1, rv2];
	}
}

function crossProduct3x2(a,b)
{
	var r1 = (a[1]*b[2])-(a[2]*b[1]);
	var r2 = (a[2]*b[0])-(a[0]*b[2]);
	var r3 = (a[0]*b[1])-(a[1]*b[0]);
	return [r1, r2, r3];
}

function testColinearity(a, b)
{
	returnVal = false;
	
	if
	(
		(a[0] == 0 && a[1] == 0 && a[2] == 0)
		||
		(b[0] == 0 && b[1] == 0 && b[2] == 0)
	)
	{
		returnVal = true;
	}
	//blocks to avoid division by 0
	
	//slot 1
	
	if (a[0] == 0 && b[0] == 0)
	{
		if (a[1] == 0)
		{
			if (b[1] == 0)
			{
				returnVal = true;
			}			
		}
		if (a[2] == 0)
		{
			if (b[2] == 0)
			{
				returnVal = true;
			}			
		}
		if (a[1] != 0 && a[2] != 0)
		{
			if (b[1]/a[1] == b[2]/b[2])
			{
				returnVal = true;
			}
		}
	}
	
	//slot 2
	
	if (a[1] == 0 && b[1] == 0)
	{
		if (a[0] == 0)
		{
			if (b[0] == 0)
			{
				returnVal = true;
			}			
		}
		if (a[2] == 0)
		{
			if (b[2] == 0)
			{
				returnVal = true;
			}			
		}
		if (a[0] != 0 && a[2] != 0)
		{
			if (b[0]/a[0] == b[2]/b[2])
			{
				returnVal = true;
			}
		}
	}
	
	//slot 3
	
	if (a[2] == 0 && b[2] == 0)
	{
		if (a[1] == 0)
		{
			if (b[1] == 0)
			{
				returnVal = true;
			}			
		}
		if (a[1] == 0)
		{
			if (b[1] == 0)
			{
				returnVal = true;
			}			
		}
		if (a[0] != 0 && a[1] != 0)
		{
			if (b[0]/a[0] == b[1]/b[1])
			{
				returnVal = true;
			}
		}
	}
	return returnVal;
}

function findLinesIntersection(a, b, c, d)
{
	
	var f1 = b[1]-a[1];
	var f2 = a[0]-b[0];
	var f3 = f1*a[0]+f2*a[1];
	
	var f4 = d[1]-c[1];
	var f5 = c[0]-d[0];
	var f6 = f1*c[0]+f2*c[1];
	
	var det = f1*f5 - f4*f2;
	
	if (det != 0)
	{
		return [(f5*f3 - f2*f6)/det, (f1*f6 - f4*f3)/det]
	}
}


function compileAreaList()
{
       
        for (var p = 0; p < areas.length; p++)
        {
               
                if (areas[p][3] != null)
                {
                        areaNames.push(areas[p][3]);
                }
               
        }
        areaNames.sort();
        document.getElementById("testDiv").innerHTML="<p>" + areaNames +"</p>";
}

function linePlaneIntersection(line, plane)
{
	// Line = Coord1, Coord2
	
	// Plane = Coord, Normal
	
	l1 = line[0];
	l2 = line[1];
	
	pC = plane[0];
	pN = plane[1];
	pUN = [pN[0]/(pN[0]+pN[1]+pN[2]), pN[1]/(pN[0]+pN[1]+pN[2]), pN[2]/(pN[0]+pN[1]+pN[2])];
	
	var u = [l2[0]-l1[0], l2[1]-l1[1], l2[2]-l1[2]]
	
	var nDotU = [pUN[0]*u[0]+pUN[1]*u[1]+pUN[2]*u[2]];
	
	var intersection;
	
	if (nDotU[0] == 0 && nDotU[0] == 1 && nDotU[0] == 2)
	{
		//line and plane are parallel
	}
	else
	{
		var w = [pC[0] - l1[0], pC[1] - l1[1], pC[2]-l1[2]];
		var nDotW = [pUN[0]*w[0]+pUN[1]*w[1]+pUN[2]*w[2]];
		var s = nDotW/nDotU;
		var intersection = [l1[0]+s*(l2[0]-l1[0]),l1[1]+s*(l2[1]-l1[1]),l1[2]+s*(l2[2]-l1[2])];
	}
	
	return intersection;
	
}

function pointRelativeToPlane(point, plane)
{
	pC = plane[0];
	pN = plane[1];
	pUN = [pN[0]/(pN[0]+pN[1]+pN[2]), pN[1]/(pN[0]+pN[1]+pN[2]), pN[2]/(pN[0]+pN[1]+pN[2])];
	
	return ((point[0]*pUN[0])+(point[1]*pUN[1])+(point[2]*pUN[2]))-((pC[0]*pUN[0])+(pC[1]*pUN[1])+(pC[2]*pUN[2]));
}

function carvePolygonWithPlane(poly, plane)
{
	var testString = "Begin: "

	var a = poly[0];
	var c = poly[2];
	var d = poly[3];
	var ret1 = [];
	var ret2 = [];
	
	for (var i = 0; i <= a[0].length; i++)
	{
		
		
		var p1 = a[i];
		var p2;
		if (i == a.length-1)
		{
			p2 = a[0];
		}
		else
		{
			p2 = a[i+1];
		}
		
		testString = testString.concat(a.length);
		if (pointRelativeToPlane(p1, plane) >= 0)
		{
			ret1.push(p1);
			
			if (pointRelativeToPlane(p2, plane) < 0)
			{
				ret1.push(linePlaneIntersection([p1, p2], plane));
				ret2.push(linePlaneIntersection([p1, p2], plane));
			}
			
			
		}
		else
		{
			ret2.push(p1);
			
			if (pointRelativeToPlane(p2, plane) >= 0)
			{
			
				ret1.push(linePlaneIntersection([p1, p2], plane));
				ret2.push(linePlaneIntersection([p1, p2], plane));
				
			}
			
		}
		
		
	}
	/*
	areas.splice(areas.indexOf(poly), 1);
	areas.push([ret1, 0, c, d]);
	areas.push([ret2, 0, c, d]);
	*/
	return [[ret1, 0, c, d], [ret2, 0, c, d]];
	
}

function BSPTree()
{
	this.coplanarSet;
	this.frontSet;
	this.backSet;
	this.hasChildren = function()
	{
		
		if ((this.frontSet.coplanarSet.length > 0) || (this.backSet.coplanarSet.length > 0))
		{
			return true;
		}
		else
		{
			return false;
		}
	}
}

function createBSPNode(set)
{
	set.sort(function(a, b){return a[1]-b[1]});
	
	var node = new BSPTree();
	
	var splitter = set[0];
	
	var backSet = [];
	var frontSet = [];
	var coplanarSet = [];
	
	
	var sP = findPlane(splitter[0]);
	
	
	for (var i = 0; i < set.length; i++)
	{
		
		poly = set[i];
		
		if (classifyPolygonRelPlane(poly, sP) == 0)
		{
			backSet.push(poly);
		}
		
		if (classifyPolygonRelPlane(poly, sP) == 1)
		{
			frontSet.push(poly);
		}
		
		if (classifyPolygonRelPlane(poly, sP) == 2)
		{
			coplanarSet.push(poly);
		}
		
		if (classifyPolygonRelPlane(poly, sP) == 3)
		{
			var splitPoly = carvePolygonWithPlane(poly, sP);
			
			frontSet.push(splitPoly[0]);
			backSet.push(splitPoly[1]);
			
		}
		
	}
	node.coplanarSet = coplanarSet;
	if (frontSet.length > 0)
	{
		node.frontSet = createBSPNode(frontSet);
		
	}
	else
	{
		node.frontSet = [];
	}
	if (backSet.length > 0)
	{
		node.backSet = createBSPNode(backSet);
	}
	else
	{
		node.backSet = [];
	}
	
	
	
	
	//return ["Front set: ", frontSet, "<br><br>Back set: ", backSet, "<br><br>Coplanar set: ", coplanarSet];
	return node;
}



function dotProduct3d(v1, v2)
{
	return (v1[0]*v2[0])+(v1[1]*v2[1])+(v1[2]*v2[2]);
}

function findCentroid(poly)
{
	var a = poly[0];
	var sumX = 0;
	var sumY = 0;
	var sumZ = 0;
	
	for (var i = 0; i < a.length; i++)
	{
		sumX = sumX + a[i][0];
		sumY = sumY + a[i][1];
		sumZ = sumZ + a[i][2];
	}
	
	return [sumX/a.length, sumY/a.length, sumZ/a.length];
}

function calculateCentroids()
{
	for (var i = 0; i < areas.length; i++)
	{
		areas[i][1] = findCentroid(areas[i]);
	}
}

function classifyPolygonRelPlane(poly, plane)
{
	var retVal;
	//0: below
	//1: above
	//2: coplanar
	//3: intersecting
	
	var pClass = [];
	var coplanar = true;
	var above = false;
	var below = false;
	
	var retVal;
	
	for (var i = 0; i < poly[0].length; i++)
	{
		point = poly[0][i];
		pClass.push(pointRelativeToPlane(point, plane));
	}
	
	for (var i = 0; i < pClass.length; i++)
	{
		if (pClass[i] != 0)
		{
			coplanar = false;
		}
		
		if (pClass[i] > 0)
		{
			above = true;
		}
		if (pClass[i] < 0)
		{
			below = true;
		}
	}
	
	if (above && !below)
	{
		retVal = 0;
	}
	
	if (below && !above)
	{
		retVal = 1;
	}
	
	if (coplanar == true)
	{
		retVal = 2;
	}
	if (above && below)
	{
		retVal = 3;
	}
	
	return retVal;
}

function traverseBSPTree(bspT)
{
	//areas = [];
	
	var areaList = [];
	
	var retString = "Node: ";
	
	var cs = bspT.coplanarSet;
	var fs = bspT.frontSet;
	var bs = bspT.backSet;
	
	var newSet;
	
	// Orientation is relative to perspective.
	
	var nodeOrientation = dotProduct3d(findPlane(cs[0][0])[1], findPerspectiveLine());
	if (nodeOrientation > 0)
	{
		
		if (bspT.frontSet.coplanarSet)
		{
			newSet = traverseBSPTree(bspT.frontSet);
			for (var i = 0; i < newSet.length; i++)
			{
				areaList.push(newSet[i]);
			}
		}
		for (var i = 0; i < bspT.coplanarSet.length; i++)
		{
			areaList.push(bspT.coplanarSet[i]);
		}
		if (bspT.backSet.coplanarSet)
		{
			newSet = traverseBSPTree(bspT.backSet);
			for (var i = 0; i < newSet.length; i++)
			{
				areaList.push(newSet[i]);
			}
		}
		
	}
	else
	{
		{
		if (bspT.backSet.coplanarSet)
		{
			newSet = traverseBSPTree(bspT.backSet);
			for (var i = 0; i < newSet.length; i++)
			{
				areaList.push(newSet[i]);
			}
		}
		
		for (var i = 0; i < bspT.coplanarSet.length; i++)
		{
			areaList.push(bspT.coplanarSet[i]);
		}
		if (bspT.frontSet.coplanarSet)
		{
			newSet = traverseBSPTree(bspT.frontSet);
			for (var i = 0; i < newSet.length; i++)
			{
				areaList.push(newSet[i]);
			}
		}
	}
	}
	document.getElementById("testDiv").innerHTML="<p>" + areaList + "</p>";
	return areaList;
	
}

function zDepth(point, vector)
{
    
}

function testFunction1()
{
        /*
		pl = findPerspectiveLine();
		document.getElementById("testDiv").innerHTML="<p>" +  dotProduct3d(findPlane(areas[0][0])[1], pl[2]) + 
		"<br>" + dotProduct3d(findPlane(areas[1][0])[1], pl[2]) + 
		"<br>" + dotProduct3d(findPlane(areas[2][0])[1], pl[2]) + 
		"</p>";
		*/
		pN = findPerspectiveLine();
		
		pUN = [pN[0]/(pN[0]+pN[1]+pN[2]), pN[1]/(pN[0]+pN[1]+pN[2]), pN[2]/(pN[0]+pN[1]+pN[2])];
		document.getElementById("testDiv").innerHTML="<p>" +  pUN + "</p>";
}

function testFunction2()
{
        var newList = traverseBSPTree(bspTree); 
		areas = [];
		for (var i = 0; i < newList.length; i++)
		{
			areas.push(newList[i]);
		}
		
		
}

function testFunction3()
{
        bspTree = createBSPNode(areas); 
		document.getElementById("testDiv").innerHTML="<p>" + bspTree.coplanarSet + "</p>";
}

function testFunction4()
{
	//document.getElementById("testDiv").innerHTML="<p>" + pointRelativeToPlane([1,1,3], [[0,0,1], [0,0,1]]) +"</p>";
	carvePolygonWithPlane(areas[1], findPlane(areas[2][0]))
	document.getElementById("testDiv").innerHTML="<p>" + findPlane(areas[2][0]) +"</p>";
}

//calibrateAbsGeo();
compileAreaList();
drawSelectionOptions();
bspTree = createBSPNode(areas); 
redraw(angleLat, angleLon, isoFlag);
redraw(angleLat, angleLon, isoFlag);
ctx.font="30px blackwell_s";

//DEBUGGING

/*document.getElementById("testDiv").innerHTML="<p>" + +"</p>";*/
       
</script>

</body>
</html> 